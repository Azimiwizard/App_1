{% extends "base.html" %}

{% block title %}{{ dish.name }}{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col -m-4">
    <header
        class="sticky top-0 z-10 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm flex items-center justify-between p-4">
        <a href="{{ url_for('menu') }}"
            class="flex items-center justify-center p-2 -ml-2 rounded-full text-text-dark dark:text-text-light hover:bg-primary/20">
            <span class="material-symbols-outlined">arrow_back</span>
        </a>
        <h1 class="text-xl font-bold text-center flex-grow text-text-dark dark:text-text-light pr-8">{{ dish.name }}
        </h1>
    </header>

    <main class="flex-grow">
        <div class="w-full aspect-[4/3] bg-cover bg-center">
            <img src="{{ dish.image_url or '/static/logo.png' }}" alt="{{ dish.name }}"
                class="w-full h-full object-cover dish-image" onerror="this.src='/static/logo.png'" />
        </div>
        <div class="p-6 space-y-4">
            <div>
                <h2 class="text-3xl font-bold text-text-dark dark:text-text-light">{{ dish.name }}</h2>
                <p class="mt-2 text-lg font-semibold text-primary">Dh{{ '%.2f'|format(dish.price) }}</p>
                <p class="mt-2 text-base text-text-dark/80 dark:text-text-light/80">
                    {{ dish.description }}
                </p>
                {% if dish.avg_rating %}
                <div class="mt-2 flex items-center">
                    <span class="text-yellow-500">
                        {% for i in range(1, 6) %}
                        {% if i <= dish.avg_rating %} ★ {% else %} ☆ {% endif %} {% endfor %} </span>
                            <span class="ml-2 text-sm text-gray-600 dark:text-gray-400">({{ dish.review_count }}
                                reviews)</span>
                </div>
                {% endif %}
            </div>

            <!-- Reviews Section -->
            <div class="mt-8">
                <h3 class="text-xl font-bold text-text-dark dark:text-text-light mb-4">Reviews</h3>
                {% if reviews %}
                <div class="space-y-4">
                    {% for review in reviews %}
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                        <div class="flex items-center mb-2">
                            {% if review.rating %}
                            <span class="text-yellow-500">
                                {% for i in range(1, 6) %}
                                {% if i <= review.rating %} ★ {% else %} ☆ {% endif %} {% endfor %} </span>
                                    {% endif %}
                                    <span class="ml-2 text-sm text-gray-600 dark:text-gray-400">{% if review.user %}{{
                                        review.user.username }}{% else %}Anonymous{% endif %}
                                        - {{ review.created_at.strftime('%Y-%m-%d') if review.created_at else 'N/A'
                                        }}</span>
                        </div>
                        {% if review.review_text %}
                        <p class="text-base text-text-dark/80 dark:text-text-light/80">{{ review.review_text }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-600 dark:text-gray-400">No reviews yet. Be the first to review!</p>
                {% endif %}

                <!-- Review Form -->
                {% if current_user.is_authenticated %}
                <div class="mt-6">
                    <h4 class="text-lg font-semibold text-text-dark dark:text-text-light mb-4">Leave a Review</h4>
                    <form method="post" action="{{ url_for('submit_review', dish_id=dish.id) }}">
                        {{ review_form.hidden_tag() }}
                        <div class="mb-4">
                            <label
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Rating</label>
                            <div class="flex space-x-2" id="rating-stars">
                                {% for value, label in review_form.rating.choices %}
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="rating" value="{{ value }}" class="sr-only peer"
                                        id="rating-{{ value }}">
                                    <span
                                        class="text-2xl text-gray-300 peer-checked:text-yellow-500 transition-colors star"
                                        data-rating="{{ value }}">★</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        <script>
                            document.querySelectorAll('.star').forEach(star => {
                                star.addEventListener('click', function () {
                                    const rating = this.getAttribute('data-rating');
                                    document.getElementById('rating-' + rating).checked = true;
                                });
                            });
                        </script>
                        <div class="mb-4">
                            <label for="review_text"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300">Feedback
                                (Optional)</label>
                            {{ review_form.review_text(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                            focus:border-primary focus:ring-primary dark:bg-gray-700 dark:border-gray-600", rows=3,
                            placeholder="Share your thoughts about this dish...") }}
                        </div>
                        <button type="submit"
                            class="bg-primary text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:bg-primary/90 transition-colors">
                            Submit Review
                        </button>
                    </form>
                </div>
                {% else %}
                <p class="mt-4 text-gray-600 dark:text-gray-400">Please <a href="{{ url_for('login') }}"
                        class="text-primary">log in</a> to leave a review.</p>
                {% endif %}
            </div>
        </div>
    </main>

    <footer class="sticky bottom-0 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm p-4">
        <form method="post" action="{{ url_for('add_to_cart', dish_id=dish.id) }}">
            <button type="submit"
                class="w-full h-14 bg-primary text-white font-bold text-lg rounded-lg shadow-lg hover:bg-primary/90 transition-colors">
                Add to Cart
            </button>
        </form>
    </footer>
</div>
{% endblock %}